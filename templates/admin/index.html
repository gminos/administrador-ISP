{% extends "admin/index.html" %}
{% load i18n %}

{% block content %}
<div class="mb-8">
    <div class="bg-white dark:bg-base-800 rounded-default border border-base-200 dark:border-base-700 shadow-sm p-6">
        <div class="flex justify-between items-end mb-2">
            <div>
                <h3 class="text-base-900 dark:text-base-100 text-lg font-semibold">Objetivo de {{ meta_data.total }}
                    servicios</h3>
            </div>
            <div class="text-right">
                <span class="text-3xl font-bold text-primary-600 dark:text-primary-400">{{ meta_data.progreso }}%</span>
                <p class="text-xs text-base-500 dark:text-base-400">Completado</p>
            </div>
        </div>
        <div class="w-full bg-base-200 dark:bg-base-700 rounded-full h-4 mb-2 overflow-hidden">
            <div class="bg-primary-600 dark:bg-primary-500 h-4 rounded-full transition-all duration-1000 ease-out relative"
                style="width: {{ meta_data.progreso }}%">
            </div>
        </div>
        <div class="flex justify-between text-xs text-base-500 dark:text-base-400 font-medium">
            <span>{{ meta_data.actual }} Servicios actuales</span>
            <span>Faltan {{ meta_data.falta }}</span>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Revenue Chart (Existing) -->
    <div
        class="bg-white dark:bg-base-800 rounded-default border border-base-200 dark:border-base-700 shadow-sm flex flex-col">
        <div class="px-6 pt-6 pb-2 flex-grow">
            <h3 class="text-base-900 dark:text-base-100 text-lg font-semibold mb-4">Evolución de Pagos</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start mb-6">
                <div class="text-center md:text-left">
                    <h3
                        class="text-base-500 dark:text-base-400 text-sm font-medium tracking-wider mb-2 h-10 flex items-center justify-center md:justify-start">
                        {{ kpi_data.recaudo.title }}
                    </h3>
                    <div class="flex items-baseline justify-center md:justify-start">
                        <p class="text-3xl font-bold text-green-600 dark:text-green-400">
                            {{ kpi_data.recaudo.metric }}
                        </p>
                    </div>
                </div>
                <div class="text-center md:text-right">
                    <h3
                        class="text-base-500 dark:text-base-400 text-sm font-medium tracking-wider mb-2 h-10 flex items-center justify-center md:justify-end">
                        {{ kpi_data.deuda.title }}
                    </h3>
                    <p class="text-3xl font-bold text-red-600 dark:text-red-400">
                        {{ kpi_data.deuda.metric }}
                    </p>
                </div>
            </div>
            <div class="relative h-64 w-full">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

    </div>

    <!-- Installation Revenue (Moved here) -->
    <div
        class="bg-white dark:bg-base-800 rounded-default border border-base-200 dark:border-base-700 shadow-sm flex flex-col">
        <div class="px-6 pt-6 pb-2 flex-grow">
            <h3 class="text-base-900 dark:text-base-100 text-lg font-semibold mb-4">Ingresos por Instalaciones</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start mb-6">
                <div class="text-center md:text-left">
                    <h3
                        class="text-base-500 dark:text-base-400 text-sm font-medium tracking-wider mb-2 h-10 flex items-center justify-center md:justify-start">
                        {{ kpi_data.inst_revenue.title }}
                    </h3>
                    <div class="flex items-baseline justify-center md:justify-start">
                        <p class="text-3xl font-bold text-green-600 dark:text-green-400">
                            {{ kpi_data.inst_revenue.metric }}
                        </p>
                    </div>
                </div>
                <div class="text-center md:text-right">
                    <h3
                        class="text-base-500 dark:text-base-400 text-sm font-medium tracking-wider mb-2 h-10 flex items-center justify-center md:justify-end">
                        {{ kpi_data.inst_revenue.year_title }}
                    </h3>
                    <p class="text-3xl font-bold text-blue-600 dark:text-blue-400">
                        {{ kpi_data.inst_revenue.year_metric }}
                    </p>
                </div>
            </div>
            <div class="relative h-64 w-full">
                <canvas id="instRevenueChart"></canvas>
            </div>
        </div>

    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <!-- Installations Count (Moved here) -->
    <div
        class="bg-white dark:bg-base-800 rounded-default border border-base-200 dark:border-base-700 shadow-sm flex flex-col">
        <div class="px-6 pt-6 pb-2 flex-grow flex flex-col">
            <h3 class="text-base-900 dark:text-base-100 text-lg font-semibold mb-4">Crecimiento de Instalaciones</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start mb-6">
                <div class="text-center md:text-left">
                    <h3
                        class="text-base-500 dark:text-base-400 text-sm font-medium tracking-wider mb-2 h-10 flex items-center justify-center md:justify-start">
                        {{ kpi_data.instalaciones.title }}
                    </h3>
                    <div class="flex items-baseline justify-center md:justify-start">
                        <p class="text-3xl font-bold text-green-600 dark:text-green-400">
                            {{ kpi_data.instalaciones.metric }}
                        </p>
                    </div>
                </div>
                <div class="text-center md:text-right">
                    <h3
                        class="text-base-500 dark:text-base-400 text-sm font-medium tracking-wider mb-2 h-10 flex items-center justify-center md:justify-end">
                        {{ kpi_data.instalaciones.year_title }}
                    </h3>
                    <p class="text-3xl font-bold text-blue-600 dark:text-blue-400">
                        {{ kpi_data.instalaciones.year_metric }}
                    </p>
                </div>
            </div>
            <div class="relative h-64 w-full mt-auto">
                <canvas id="installationsChart"></canvas>
            </div>
        </div>

    </div>

    <!-- Plans Distribution -->
    <div class="bg-white dark:bg-base-800 rounded-default border border-base-200 dark:border-base-700 shadow-sm p-6">
        <h3 class="text-base-900 dark:text-base-100 text-lg font-semibold mb-4">Distribución de planes</h3>
        <div class="relative h-64 w-full">
            <canvas id="plansChart"></canvas>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <!-- Payment Methods (Moved here) -->
    <div class="bg-white dark:bg-base-800 rounded-default border border-base-200 dark:border-base-700 shadow-sm p-6">
        <h3 class="text-base-900 dark:text-base-100 text-lg font-semibold mb-4">Ingresos por método de pago</h3>
        <div class="relative h-64 w-full">
            <canvas id="paymentMethodChart"></canvas>
        </div>
    </div>

    <!-- Veredas -->
    <div class="bg-white dark:bg-base-800 rounded-default border border-base-200 dark:border-base-700 shadow-sm p-6">
        <h3 class="text-base-900 dark:text-base-100 text-lg font-semibold mb-4">Instalaciones por vereda</h3>
        <div class="relative h-64 w-full">
            <canvas id="veredasChart"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const isDark = document.documentElement.classList.contains('dark');
        const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        const tickColor = isDark ? '#9ca3af' : '#4b5563';

        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: gridColor
                    },
                    ticks: {
                        color: tickColor
                    }
                },
                x: {
                    grid: {
                        display: true,
                        drawOnChartArea: false,
                        drawBorder: true,
                        color: gridColor
                    },
                    ticks: {
                        color: tickColor
                    }
                }
            }
        };

        const pieOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: tickColor,
                        usePointStyle: true,
                        padding: 20
                    }
                }
            }
        };

        new Chart(document.getElementById('revenueChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: {{ chart_labels| safe }},
        datasets: [{
            label: 'Ingresos',
            data: {{ chart_data| safe }},
        borderColor: '#9333ea',
        backgroundColor: 'rgba(147, 51, 234, 0.1)',
        borderWidth: 2,
        fill: true,
        tension: 0.4,
        pointRadius: 6,
        pointHoverRadius: 10,
        pointHitRadius: 30
                    }]
                },
        options: commonOptions
            });

    new Chart(document.getElementById('installationsChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: {{ inst_labels| safe }},
        datasets: [{
            label: 'Instalaciones',
            data: {{ inst_count| safe }},
        backgroundColor: '#3b82f6',
        borderRadius: {
            topLeft: 4,
            topRight: 4,
            bottomLeft: 0,
            bottomRight: 0
        },
        borderSkipped: false
                    }]
                },
        options: {
        ...commonOptions,
        barPercentage: 0.7,
        categoryPercentage: 0.8
    }
            });

    new Chart(document.getElementById('paymentMethodChart').getContext('2d'), {
        type: 'pie',
        data: {
            labels: {{ payment_method_labels| safe }},
        datasets: [{
            data: {{ payment_method_data| safe }},
        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b'],
        hoverBackgroundColor: ['#3b82f6', '#10b981', '#f59e0b'],
        borderWidth: 0
                    }]
                },
        options: pieOptions
            });

    new Chart(document.getElementById('plansChart').getContext('2d'), {
        type: 'pie',
        data: {
            labels: {{ plans_labels| safe }},
        datasets: [{
            data: {{ plans_data| safe }},
        backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#06b6d4'],
        hoverBackgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#06b6d4'],
        borderWidth: 0
                    }]
                },
        options: pieOptions
            });

    new Chart(document.getElementById('instRevenueChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: {{ inst_labels| safe }},
        datasets: [{
            label: 'Ingresos Instalación',
            data: {{ inst_revenue| safe }},
        borderColor: '#10b981',
        backgroundColor: 'rgba(16, 185, 129, 0.1)',
        borderWidth: 2,
        fill: true,
        tension: 0.4,
        pointRadius: 6,
        pointHoverRadius: 10,
        pointHitRadius: 30
                    }]
                },
        options: commonOptions
            });

    new Chart(document.getElementById('veredasChart').getContext('2d'), {
        type: 'pie',
        data: {
            labels: {{ veredas_labels| safe }},
        datasets: [{
            label: 'Instalaciones',
            data: {{ veredas_data| safe }},
        backgroundColor: [
            '#3b82f6', // Blue
            '#8b5cf6', // Purple
            '#10b981', // Green
            '#f59e0b', // Amber
            '#ef4444', // Red
            '#06b6d4'  // Cyan
        ],
        hoverBackgroundColor: [
            '#3b82f6',
            '#8b5cf6',
            '#10b981',
            '#f59e0b',
            '#ef4444',
            '#06b6d4'
        ],
        borderWidth: 0
                    }]
                },
        options: pieOptions
            });
        });
</script>
{% endblock %}